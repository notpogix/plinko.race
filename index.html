<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plinko Race — Large Visuals + Live Leaderboard</title>
<style>
  :root{
    --bg:#071827;
    --panel:#0b1220;
    --accent:#06b6d4;
    --text:#e6eef6;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body{background:linear-gradient(180deg,#04101a 0%, #071827 60%);color:var(--text);display:flex;gap:18px;padding:18px;align-items:stretch}
  .sidebar{width:360px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow:0 8px 28px rgba(2,6,23,0.6);display:flex;flex-direction:column}
  .sidebar h3{margin:6px 0 12px 0;font-size:18px;color:var(--accent)}
  .inputRow{display:flex;gap:8px;margin-bottom:12px;align-items:center}
  .inputRow input{flex:1;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);outline:none;font-size:16px}
  .controls{display:flex;gap:8px;margin-bottom:12px}
  button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#022;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .namesList{max-height:20vh;overflow:auto;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px dashed rgba(255,255,255,0.02);margin-bottom:12px}
  .nameItem{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin:6px 0}
  .colorDot{width:20px;height:20px;border-radius:50%;box-shadow:0 3px 8px rgba(0,0,0,0.6) inset}
  .leaderboard{margin-top:8px;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;max-height:36vh;overflow:auto}
  .lbItem{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;margin:4px 0}
  .lbName{display:flex;align-items:center;gap:8px}
  .stat{font-size:12px;color:rgba(255,255,255,0.6)}
  .bigCount{font-weight:700;color:var(--accent)}
  .main{flex:1;display:flex;flex-direction:column;gap:12px}
  .canvasWrap{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;display:flex;flex-direction:column}
  #gameCanvas{width:100%;height:100%;border-radius:10px;background:linear-gradient(180deg,#071827,#04101a);display:block}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;color:rgba(255,255,255,0.6)}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071827;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.8);min-width:520px;z-index:40}
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.6);z-index:30}
  .modal h2{margin:0 0 8px 0;color:var(--accent)}
  .modal p{margin:0 0 12px 0}
  .modal .opts{display:flex;gap:8px;justify-content:flex-end}
  table.leader{width:100%;border-collapse:collapse;margin-top:8px}
  table.leader th, table.leader td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:13px}
  table.leader th{color:var(--accent);font-weight:700}
  .small{font-size:13px;color:rgba(255,255,255,0.6)}
  .namesList::-webkit-scrollbar,.leaderboard::-webkit-scrollbar{width:8px}
  .namesList::-webkit-scrollbar-thumb,.leaderboard::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.04);border-radius:6px}
  @media (max-width:1000px){
    body{flex-direction:column;padding:12px}
    .sidebar{width:100%}
  }
</style>
</head>
<body>
  <div class="sidebar">
    <h3>Plinko Race</h3>

    <div class="inputRow">
      <input id="nameInput" placeholder="Type name and press Enter" />
      <button id="addBtn">Add</button>
    </div>

    <div class="controls">
      <button id="startBtn">Start Race</button>
      <button id="pauseBtn" class="ghost">Pause</button>
      <button id="restartBtn" class="ghost">Restart</button>
    </div>

    <h3 style="margin-top:6px">Participants</h3>
    <div class="namesList" id="namesList"></div>

    <h3 style="margin-top:8px">Live Leaderboard</h3>
    <div class="leaderboard" id="leaderboard"></div>

    <div style="margin-top:12px">
      <div class="small">Type a name and press Enter or click Add. Leaderboard updates live while balls race.</div>
    </div>
  </div>

  <div class="main">
    <div class="canvasWrap">
      <canvas id="gameCanvas"></canvas>
    </div>
    <div class="footer">
      <div class="small">Balls: <span id="ballCount">0</span> • Finished: <span id="finishedCount">0</span></div>
      <div class="small">Large visuals, full-size canvas • Desktop recommended</div>
    </div>
  </div>

  <div id="overlay" class="overlay" style="display:none"></div>
  <div id="modal" class="modal" style="display:none">
    <h2 id="modalTitle">Race Results</h2>
    <p id="modalBody"></p>
    <div id="leaderWrap"></div>
    <div class="opts" style="margin-top:12px">
      <button id="restartAll">Restart (all)</button>
      <button id="restartElimLast" class="ghost">Restart (eliminate last)</button>
      <button id="restartElimWinner" class="ghost">Restart (eliminate winner)</button>
    </div>
  </div>

<script>
/* Plinko — larger balls/pegs/spacing, full-size canvas, enlarged name input, live leaderboard */

const SCALE = 1.35; // increase sizes and spacing
const BALL_RADIUS = Math.round(12 * SCALE);
const PEG_RADIUS = Math.round(6 * SCALE);
const PEG_SPACING_X = 56 * SCALE;
const PEG_SPACING_Y = 48 * SCALE;

const GRAVITY = 0.03;            // slow gravity for longer rounds
const FRICTION = 0.9994;         // gentle damping
const WALL_BOUNCE = 0.82;
const FINISH_ZONE_HEIGHT = 100;  // visible finish zone
const FINISH_LINE_THICK = 12;    // thick finish stripe
const SETTLE_VEL = 0.12;         // threshold to consider settling
const SETTLE_FRAMES = 6;         // frames under threshold to mark finished

/* DOM */
const nameInput = document.getElementById('nameInput');
const addBtn = document.getElementById('addBtn');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const namesListEl = document.getElementById('namesList');
const leaderboardEl = document.getElementById('leaderboard');
const ballCountEl = document.getElementById('ballCount');
const finishedCountEl = document.getElementById('finishedCount');

const overlay = document.getElementById('overlay');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const leaderWrap = document.getElementById('leaderWrap');
const restartAll = document.getElementById('restartAll');
const restartElimLast = document.getElementById('restartElimLast');
const restartElimWinner = document.getElementById('restartElimWinner');

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });

/* Keep canvas full-size (use parent size) */
function resizeCanvas(){
  const wrap = canvas.parentElement.getBoundingClientRect();
  const width = Math.max(900, wrap.width - 0); // keep full available width
  const height = Math.max(700, wrap.height - 0); // keep full available height
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.floor(width * DPR);
  canvas.height = Math.floor(height * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* State */
let participants = []; // {name,color,active}
let balls = [];        // dynamic balls
let pegs = [];
let finished = [];     // {name,color,finishTime}
let running = false;
let paused = false;
let startTime = 0;
let rafId = null;

/* Utilities */
function colorForIndex(i, total){
  const hue = Math.round((i * 360 / Math.max(1,total)) % 360);
  return `hsl(${hue} 78% 52%)`;
}

/* Participants UI */
function renderParticipants(){
  namesListEl.innerHTML = '';
  participants.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'nameItem';
    div.innerHTML = `<div class="colorDot" style="background:${p.color}"></div>
                     <div style="flex:1"><strong>${p.name}</strong><div class="small">#${i+1}</div></div>
                     <button class="ghost" data-i="${i}" style="padding:6px 8px">Remove</button>`;
    namesListEl.appendChild(div);
  });
  namesListEl.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.dataset.i);
      participants.splice(i,1);
      participants = participants.map((p, idx)=>({name:p.name, color:colorForIndex(idx, Math.max(8,participants.length)), active:true}));
      renderParticipants();
    });
  });
  ballCountEl.textContent = participants.length;
}

/* Live leaderboard update */
function updateLiveLeaderboard(){
  // finished sorted by finishTime ascending
  const finishedSorted = [...finished].sort((a,b)=>a.finishTime - b.finishTime);
  // ongoing sorted by y descending (closer to bottom first)
  const ongoing = balls.filter(b=>!b.finished).map(b=>({name:b.name,color:b.color,y:b.y}));
  ongoing.sort((a,b)=>b.y - a.y);

  const display = finishedSorted.map((f,i)=>({pos:i+1, name:f.name, color:f.color, status:'Finished', time:Math.round(f.finishTime)}))
    .concat(ongoing.map((o,i)=>({pos: finishedSorted.length + i + 1, name:o.name, color:o.color, status:'Racing', time:null})));

  leaderboardEl.innerHTML = '';
  display.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'lbItem';
    div.innerHTML = `<div class="lbName"><div style="width:18px;height:18px;border-radius:50%;background:${item.color};box-shadow:0 2px 6px rgba(0,0,0,0.6)"></div>
                     <div style="margin-left:6px"><strong>${item.name}</strong><div class="stat">${item.status}${item.time ? ' • ' + item.time + ' ms' : ''}</div></div></div>
                     <div class="bigCount">#${item.pos}</div>`;
    leaderboardEl.appendChild(div);
  });
}

/* Add name */
function addNameFromInput(){
  const raw = nameInput.value || '';
  const name = raw.trim();
  if(!name) return;
  if(participants.some(p=>p.name.toLowerCase()===name.toLowerCase())){
    alert('Name already added.');
    nameInput.value = '';
    return;
  }
  const idx = participants.length;
  participants.push({name, color: colorForIndex(idx, Math.max(8, participants.length)), active:true});
  renderParticipants();
  nameInput.value = '';
}
addBtn.addEventListener('click', addNameFromInput);
nameInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter') addNameFromInput();
});

/* Controls */
pauseBtn.addEventListener('click', ()=>{
  if(!running) return;
  paused = !paused;
  pauseBtn.textContent = paused ? 'Resume' : 'Pause';
  if(!paused) loop();
});
restartBtn.addEventListener('click', ()=>{
  participants = [];
  renderParticipants();
  resetGame();
});

/* Map builder */
function buildMap(){
  pegs = [];
  const W = canvas.width / (window.devicePixelRatio || 1);
  const H = canvas.height / (window.devicePixelRatio || 1);

  const cols = Math.max(6, Math.floor(W / PEG_SPACING_X));
  const rows = Math.max(10, Math.floor((H * 0.72) / PEG_SPACING_Y) + 6);

  const xSpacing = W / Math.max(1, cols);
  const ySpacing = (H * 0.72) / Math.max(1, rows);

  for(let r=0;r<rows;r++){
    const y = 70 + r * ySpacing;
    const offset = (r % 2) * (xSpacing/2);
    for(let c=0;c<cols;c++){
      const x = offset + (c + 0.5) * xSpacing;
      const jitter = (Math.random()-0.5) * 6;
      pegs.push({x: x + jitter, y: y + (Math.random()-0.5)*4, r: PEG_RADIUS});
    }
  }
}

/* Reset */
function resetGame(keepParticipants=false){
  balls = [];
  finished = [];
  running = false;
  paused = false;
  startTime = 0;
  renderParticipants();
  buildMap();
  draw();
  document.getElementById('finishedCount').textContent = '0';
  leaderboardEl.innerHTML = '';
}

/* Spawn balls */
function spawnBalls(){
  balls = [];
  const W = canvas.width / (window.devicePixelRatio || 1);
  const spawnXStart = W * 0.12;
  const spawnXEnd = W * 0.88;
  const spacing = (spawnXEnd - spawnXStart) / Math.max(1, participants.length);
  participants.forEach((p, i)=>{
    if(!p.active) return;
    const x = spawnXStart + spacing * (i + 0.5) + (Math.random()-0.5)*8;
    const y = 30 + Math.random()*8;
    balls.push({
      id: i,
      name: p.name,
      color: p.color,
      x, y,
      vx: (Math.random()-0.5)*0.25,
      vy: 0,
      r: BALL_RADIUS,
      finished: false,
      finishTime: null,
      settleFrames: 0
    });
  });
  ballCountEl.textContent = balls.length;
}

/* Physics step */
function stepPhysics(){
  const W = canvas.width / (window.devicePixelRatio || 1);
  const H = canvas.height / (window.devicePixelRatio || 1);
  const finishTop = H - FINISH_ZONE_HEIGHT;

  for(let b of balls){
    if(b.finished) continue;

    // integrate
    b.vy += GRAVITY;
    b.vx *= FRICTION;
    b.vy *= FRICTION;
    b.x += b.vx;
    b.y += b.vy;

    // walls
    if(b.x - b.r < 0){ b.x = b.r; b.vx = Math.abs(b.vx) * WALL_BOUNCE; }
    if(b.x + b.r > W){ b.x = W - b.r; b.vx = -Math.abs(b.vx) * WALL_BOUNCE; }

    // peg collisions (AABB quick skip)
    for(let p of pegs){
      if(Math.abs(b.x - p.x) > (b.r + p.r + 8)) continue;
      if(Math.abs(b.y - p.y) > (b.r + p.r + 8)) continue;
      const dx = b.x - p.x;
      const dy = b.y - p.y;
      const dist = Math.hypot(dx,dy);
      const minDist = b.r + p.r;
      if(dist < minDist && dist > 0){
        const nx = dx / dist;
        const ny = dy / dist;
        const overlap = minDist - dist;
        b.x += nx * overlap;
        b.y += ny * overlap;
        const dot = b.vx * nx + b.vy * ny;
        b.vx = b.vx - 2 * dot * nx;
        b.vy = b.vy - 2 * dot * ny;
        b.vx *= 0.92;
        b.vy *= 0.92;
      }
    }

    // finish zone: bounce and settle (no bins)
    if(b.y + b.r >= finishTop){
      if(b.y + b.r > H - 8) b.y = H - 8 - b.r;
      if(b.vy > 0) b.vy = -Math.abs(b.vy) * 0.35;
      b.vx *= 0.88;

      const speed = Math.hypot(b.vx, b.vy);
      if(speed < SETTLE_VEL){
        b.settleFrames = (b.settleFrames || 0) + 1;
      } else {
        b.settleFrames = 0;
      }
      if(b.settleFrames >= SETTLE_FRAMES){
        b.finished = true;
        b.finishTime = performance.now() - startTime;
        finished.push({name: b.name, color: b.color, finishTime: b.finishTime});
        document.getElementById('finishedCount').textContent = finished.length;
        b.vx = 0;
        b.vy = 0;
        b.y = finishTop + (FINISH_ZONE_HEIGHT/2) - b.r + (Math.random()*6 - 3);
      }
    }
  }
}

/* Draw */
function draw(){
  const W = canvas.width / (window.devicePixelRatio || 1);
  const H = canvas.height / (window.devicePixelRatio || 1);
  ctx.clearRect(0,0,W,H);

  // background
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#071827');
  g.addColorStop(1,'#04101a');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // pegs (obstacles)
  ctx.fillStyle = 'rgba(255,255,255,0.06)';
  for(let p of pegs){
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }

  // finish zone and bold finish line
  const finishTop = H - FINISH_ZONE_HEIGHT;
  ctx.fillStyle = 'rgba(6,182,212,0.12)';
  ctx.fillRect(0, finishTop, W, FINISH_ZONE_HEIGHT);
  ctx.fillStyle = 'rgba(6,182,212,0.95)';
  ctx.fillRect(0, finishTop - FINISH_LINE_THICK, W, FINISH_LINE_THICK);
  ctx.fillStyle = '#ffffff';
  ctx.font = '22px Inter, Arial';
  ctx.textAlign = 'center';
  ctx.fillText('FINISH', W/2, finishTop - FINISH_LINE_THICK - 14);

  // balls
  for(let b of balls){
    // shadow
    ctx.beginPath();
    ctx.ellipse(b.x+8, b.y+10, b.r*1.08, b.r*0.6, 0, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(0,0,0,0.36)';
    ctx.fill();

    // sphere gradient
    const grad = ctx.createRadialGradient(b.x - b.r*0.35, b.y - b.r*0.6, b.r*0.2, b.x, b.y, b.r*1.2);
    grad.addColorStop(0, lighten(b.color, 18));
    grad.addColorStop(0.6, b.color);
    grad.addColorStop(1, darken(b.color, 12));
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();

    // name label
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.font = '12px Inter, Arial';
    ctx.textAlign = 'center';
    ctx.fillText(b.name, b.x, b.y - b.r - 10);
  }

  // finished count
  ctx.fillStyle = 'rgba(255,255,255,0.06)';
  ctx.font = '12px Inter, Arial';
  ctx.textAlign = 'left';
  ctx.fillText(`Finished: ${finished.length}`, 12, 22);
}

/* Color helpers */
function lighten(hsl, amt){
  const m = hsl.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/);
  if(!m) return hsl;
  const h = m[1], s = m[2], l = Math.min(100, Number(m[3]) + amt);
  return `hsl(${h} ${s}% ${l}%)`;
}
function darken(hsl, amt){
  const m = hsl.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/);
  if(!m) return hsl;
  const h = m[1], s = m[2], l = Math.max(0, Number(m[3]) - amt);
  return `hsl(${h} ${s}% ${l}%)`;
}

/* Live leaderboard builder for final modal */
function showWinnerModal(){
  if(finished.length === 0) return;
  const sorted = [...finished].sort((a,b)=>a.finishTime - b.finishTime);
  modalTitle.textContent = `Race Results — ${sorted[0].name} wins`;
  modalBody.innerHTML = `<div class="small">Full leaderboard with finish times (ms). Non-finishers show as —.</div>`;

  // Build full leaderboard: finished first, then non-finished in current order
  const finishedNames = new Set(sorted.map(s=>s.name));
  const ongoing = balls.filter(b=>!b.finished).map(b=>({name:b.name,color:b.color}));
  let html = '<table class="leader"><thead><tr><th>#</th><th>Name</th><th>Time (ms)</th></tr></thead><tbody>';
  sorted.forEach((f,i)=>{
    html += `<tr><td>${i+1}</td><td style="color:${f.color}">${escapeHtml(f.name)}</td><td>${Math.round(f.finishTime)}</td></tr>`;
  });
  ongoing.forEach((o, idx)=>{
    html += `<tr><td>${sorted.length + idx + 1}</td><td style="color:${o.color}">${escapeHtml(o.name)}</td><td>—</td></tr>`;
  });
  // include any participants not in balls (edge cases)
  participants.forEach(p=>{
    if(!finishedNames.has(p.name) && !ongoing.some(o=>o.name===p.name)){
      html += `<tr><td>—</td><td style="color:${p.color}">${escapeHtml(p.name)}</td><td>—</td></tr>`;
    }
  });
  html += '</tbody></table>';
  leaderWrap.innerHTML = html;

  overlay.style.display = 'block';
  modal.style.display = 'block';
}

/* Modal actions */
restartAll.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  modal.style.display = 'none';
  participants = participants.map(p=>({name:p.name,color:p.color,active:true}));
  resetGame();
});
restartElimLast.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  modal.style.display = 'none';
  if(finished.length === 0) return;
  const sorted = [...finished].sort((a,b)=>a.finishTime - b.finishTime);
  const last = sorted[sorted.length-1];
  participants = participants.filter(p=>p.name !== last.name);
  renderParticipants();
  resetGame();
});
restartElimWinner.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  modal.style.display = 'none';
  if(finished.length === 0) return;
  const sorted = [...finished].sort((a,b)=>a.finishTime - b.finishTime);
  const winner = sorted[0];
  participants = participants.filter(p=>p.name !== winner.name);
  renderParticipants();
  resetGame();
});

/* Start */
startBtn.addEventListener('click', ()=>{
  if(running) return;
  if(participants.length === 0) return alert('Add at least one name.');
  participants = participants.map((p, idx)=>({name:p.name,color:colorForIndex(idx, Math.max(8,participants.length)),active:true}));
  renderParticipants();
  resetGame(true);
  spawnBalls();
  running = true;
  paused = false;
  pauseBtn.textContent = 'Pause';
  startTime = performance.now();
  if(rafId) cancelAnimationFrame(rafId);
  loop();
});

/* Main loop */
function loop(){
  if(paused){
    rafId = requestAnimationFrame(loop);
    return;
  }
  stepPhysics();
  draw();
  updateLiveLeaderboard();
  if(finished.length === balls.length && balls.length > 0 && running){
    running = false;
    setTimeout(()=>showWinnerModal(), 450);
  } else {
    rafId = requestAnimationFrame(loop);
  }
}

/* Helpers */
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function colorForIndex(i, total){
  const hue = Math.round((i * 360 / Math.max(1,total)) % 360);
  return `hsl(${hue} 78% 52%)`;
}

/* Init */
resetGame();
ctx.fillStyle = 'rgba(255,255,255,0.06)';
ctx.font = '14px Inter, Arial';
ctx.textAlign = 'center';
ctx.fillText('Type a name and press Enter, then Start Race', canvas.width/(2*(window.devicePixelRatio||1)), canvas.height/(2*(window.devicePixelRatio||1)));
</script>
</body>
</html>
